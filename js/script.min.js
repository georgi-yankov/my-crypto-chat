var myNameSpace=myNameSpace||{};myNameSpace.CryptoChat=function(){function tt(){var t,i,n;d.innerHTML=a.mainNavULHTML,b.innerHTML=a.usersPanelHTML,h.innerHTML=a.contentHTML,g.innerHTML=a.infoPanelHTML,t=document.getElementById("register-nav-button"),i=document.getElementById("login-nav-button"),document.getElementById("who-invites-you")&&(n=document.getElementById("who-invites-you"),n.parentNode.removeChild(n)),f(t,"click",ct),f(i,"click",at)}function ct(n){var t;h.innerHTML='<!-- REGISTRATION FORM --><h2 class="reg-form-title">Registratiion form<\/h2><form id="reg-form" class="reg-and-login-form" role="form"><p><label for="tb-username">Username:<\/label><input id="tb-username" type="text" placeholder="username" autofocus required tabindex="1" /><\/p><p><label for="tb-password">Password:<\/label><input id="tb-password" type="password" placeholder="password" required tabindex="2" /><\/p><p><label for="tb-password-retype">Password (retype):<\/label><input id="tb-password-retype" type="password" placeholder="password" required tabindex="3" /><\/p><p><input id="submit-reg-form" type="submit" value="Get registered" tabindex="4" /><\/p><\/form>',i.loadInfoPanel(),t=document.getElementById("submit-reg-form"),f(t,"click",lt),o(n)}function lt(i){var u={username:document.getElementById("tb-username").value,password:document.getElementById("tb-password").value,passwordRetype:document.getElementById("tb-password-retype").value,errorList:[],isValid:!1,validate:function(){var n=/^[A-Za-z0-9\.\-\_]{6,20}$/;this.username===""||this.password===""||this.passwordRetype===""?this.errorList.push("Please fill in all of the input fields!"):/^[A-Za-z0-9\.\-\_]{1,30}$/.test(this.username)?n.test(this.password)&&n.test(this.passwordRetype)?this.password!==this.passwordRetype?this.errorList.push("Your passswords don't match."):this.isValid=!0:this.errorList.push("Your passswords must have at least 6 - 20 characters that are letters, numbers, dot, dash or underscore"):this.errorList.push("Username needs to have at least 1 - 30 characters that are letters, numbers, dot, dash or underscore")}},f;u.validate(),u.isValid?(f={username:u.username,authCode:e.SHA1Algorithm(u.username,u.password)},r.performPostRequest(t+"register",f,it,rt),n.name=u.username):ut(u.errorList),o(i)}function at(n){var t;h.innerHTML='<!-- LOGIN FORM --><h2 class="login-form-title">Login form<\/h2><form id="login-form" class="reg-and-login-form" role="form"><p><label for="tb-username">Username:<\/label><input id="tb-username" type="text" placeholder="username" autofocus required tabindex="1" /><\/p><p><label for="tb-password">Password:<\/label><input id="tb-password" type="password" placeholder="password" required tabindex="2" /><\/p><p><input id="submit-login-form" type="submit" value="Login" tabindex="3" /><\/p><\/form>',t=document.getElementById("submit-login-form"),f(t,"click",vt),i.loadInfoPanel(),o(n)}function vt(i){var u={username:document.getElementById("tb-username").value,password:document.getElementById("tb-password").value,errorList:[],isValid:!1,validate:function(){this.username===""||this.password===""?this.errorList.push("Please fill in all of the input fields!"):/^[A-Za-z0-9\.\-\_]{1,30}$/.test(this.username)&&/^[A-Za-z0-9\.\-\_]{6,20}$/.test(this.password)?this.isValid=!0:this.errorList.push("Username or password is not correct!")}},f;u.validate(),u.isValid?(f={username:u.username,authCode:e.SHA1Algorithm(u.username,u.password)},r.performPostRequest(t+"login",f,it,rt),n.name=u.username):ut(u.errorList),o(i)}function it(t){sessionStorage.setItem("isLoggedIn",!0),sessionStorage.setItem("name",n.name),sessionStorage.setItem("sessionID",t.sessionID),n.isLoggedIn=!0,n.sessionID=t.sessionID,i.loadMainNavIfLogged(),v(),i.loadWhoInvitesYou(),i.loadChatBox(),i.loadInfoPanel(),l=setInterval(et,500),s=300,nt=setInterval(gt,1e3)}function rt(t){n.name="",u(t)}function ut(n){var i="",t;for($("div.form-error-box")[0]||$("#content").append('<div class="form-error-box"><\/div>'),t=0;t<n.length;t++)i+="<p>"+n[t]+"<\/p>";$("div.form-error-box").html(i)}function v(){b.innerHTML='<img src="img/ajax-loader.gif" width="16" height="11" alt="Loading image" />',r.performGetRequest(t+"list-users/"+n.sessionID,yt,pt)}function yt(n){for(var r=n.length,i="<h3>Online users:<\/h3><ul>",t=0;t<r;t++)i+='<li><a data-user-id="user-'+t+'" href="#">'+n[t]+"<\/a><\/li>";i+="<\/ul>",b.innerHTML=i;$("#users-panel li a").on("click",wt)}function pt(n){u(n)}function wt(n){var t=$(this),i,r,u;c={id:t.data("user-id"),name:t.text()},i='<p>You want to invite <span class="bold">'+c.name+'<\/span> for chat?<\/p><form role="form"><label for="secret-key-value">Enter secret key: <\/label><input id="secret-key-value" type="text" placeholder="secret key" required autofocus /><button id="secret-key-button">invite<\/button><\/form>',r=$("#prepare-for-chat"),r.html(i).slideDown(),u=document.getElementById("secret-key-button"),f(u,"click",bt),o(n)}function bt(i){var s;if(document.getElementById("secret-key-value").value!==""){var h=Math.floor(Math.random()*1e9),f=document.getElementById("secret-key-value").value,l=e.encrypt(h,f);n.sentKey=f,s={sessionID:n.sessionID,recipientUsername:c.name,challenge:l},r.performPostRequest(t+"invite-user",s,function(){var n=$("#prepare-for-chat");n.slideUp(function(){n.html('<p class="success-notice">Invitation to <span class="bold">'+c.name+"<\/span> is sent, please wait for his response!<\/p>")}),n.slideDown()},function(n){u(n)}),o(i)}}function u(n){var i=JSON.stringify(n),r,t;i=JSON.parse(i),i.responseText===""?(clearInterval(l),ft("No Internet connection!")):(r=JSON.parse(n.responseText),t={errorCode:r.errorCode,errorMsg:r.errorMsg},t.errorCode==="ERR_BAD_MSG"&&(t.errorMsg="Can't send long messages!"),ft(t.errorMsg))}function ft(n){var r=document.getElementById("server-errors"),u=y(),t=r.getElementsByTagName("ul")[0],i=document.createElement("li");i.innerHTML="<span>"+u+"<\/span>"+n,t.appendChild(i),p(t)}function et(){r.performGetRequest(t+"get-next-message/"+n.sessionID,function(i){function st(t){var i=$(this).closest("li");i.find("div.accept-invitation-box").length===0&&(i.append('<div class="accept-invitation-box"><input type="text" placeholder="secret key" required autofocus /><button class="check-invitation-key-button">ok<\/button><\/div>'),i.find("div.accept-invitation-box").slideDown());$("button.check-invitation-key-button").on("click",function(){var t=i.find("input").val();t!==""&&(n.returnedKey=t,kt(a,t))});o(t)}var a=i.msgText,l=i.msgType,h=i.username,et=y(),c,b,w,d,g,nt,tt,it,rt;if(l!=="MSG_NO_MESSAGES"){l!=="MSG_USER_ONLINE"&&l!=="MSG_USER_OFFLINE"&&(s=300),c="<span>"+et+"<\/span>";switch(l){case"MSG_USER_ONLINE":c+=h+" is online",v();break;case"MSG_USER_OFFLINE":c+=h+" is offline",v();break;case"MSG_CHALLENGE":c+=h+" invites you",n.recipientUsername=h,b=document.getElementById("who-invites-you").getElementsByTagName("ul")[0],w=document.createElement("li"),w.innerHTML='<a class="accept-button" href="#" title="Accept invitation from '+h+'">'+h+'<\/a><button class="deny-button" title="Cancel invitation or chat">x<\/button>',b.appendChild(w);$("#who-invites-you button.deny-button").on("click",k);$("#who-invites-you a.accept-button").on("click",st);break;case"MSG_RESPONSE":c+=h+" sent a response to your chat invitation ",n.sender=h,d=e.decrypt(a,n.sentKey),g=999999999-parseInt(d,10),g?(nt={sessionID:n.sessionID,recipientUsername:h},r.performPostRequest(t+"start-chat",nt,function(){$("#chat-box-button").removeAttr("disabled"),$("#chat-box-input").removeAttr("disabled"),$("#cancel-chat").removeAttr("disabled"),$("#prepare-for-chat").slideUp(function(){$(this).html('<p class="success-notice">Enjoy your chat with <span class="bold">'+h+"<\/span>!<\/p>")}).slideDown().delay(3e3).slideUp();var n=document.getElementById("cancel-chat");f(n,"click",k)},function(n){u(n)})):$("#prepare-for-chat").slideUp(function(){$(this).html('<p class="error-notice"><span class="bold">'+h+"<\/span> responded with wrong key!<\/p>")}).slideDown();break;case"MSG_START_CHAT":c+=h+" started a chat with you",$("#chat-box-button").removeAttr("disabled"),$("#chat-box-input").removeAttr("disabled"),$("#cancel-chat").removeAttr("disabled"),$("#prepare-for-chat").slideUp(function(){$(this).html('<p class="success-notice">Enjoy your chat with <span class="bold">'+h+"<\/span>!<\/p>")}).slideDown().delay(3e3).slideUp(),$("#who-invites-you a.accept-button").parent("li").slideUp(function(){$(this).remove()}),tt=document.getElementById("cancel-chat"),f(tt,"click",k);break;case"MSG_CANCEL_CHAT":c+=h+" canceled to a chat invitation or а chat session with you",$("#prepare-for-chat").slideUp(function(){$(this).html('<p class="error-notice"><span class="bold">'+h+"<\/span> canceled your chat invitation or session!<\/p>")}).slideDown(),$("#chat-box-button").attr("disabled","disabled"),$("#chat-box-input").attr("disabled","disabled"),$("#cancel-chat").attr("disabled","disabled");break;case"MSG_CHAT_MESSAGE":c+=h+" sent you a message.",it=e.decrypt(a,n.sentKey||n.returnedKey),$("#chat-box-screen").append('<p><span class="chat-box-nick chat-box-nick-second">'+h+':<\/span><span class="message-block">'+it+'<\/span><span class="message-time">'+y()+"<\/span><\/p>"),rt=document.getElementById("chat-box-screen-wrapper"),p(rt);break;default:c+="something is wrong!!!"}var ot=document.getElementById("server-messages"),ut=ot.getElementsByTagName("ul")[0],ft=document.createElement("li");ft.innerHTML=c,ut.appendChild(ft),p(ut)}},function(n){u(n)})}function k(){var i=$(this),f={sessionID:n.sessionID,recipientUsername:n.recipientUsername||n.sender};i.hasClass("deny-button")&&i.closest("li").slideUp(function(){$(this).remove()}),r.performPostRequest(t+"cancel-chat",f,function(){$("#chat-box-button").attr("disabled","disabled"),$("#chat-box-input").attr("disabled","disabled"),$("#cancel-chat").attr("disabled","disabled")},function(n){u(n)})}function kt(t,i){var r=e.decrypt(t,i),u=999999999-r,f=e.encrypt(u,i),o={sessionID:n.sessionID,recipientUsername:n.recipientUsername,response:f};r===""&&$("#prepare-for-chat").slideUp(function(){$(this).html('<p class="error-notice">Your keys don\'t match, please try with another key!<\/p>')}).slideDown(),dt(o)}function dt(n){r.performPostRequest(t+"response-chat-invitation",n,function(){},function(n){u(n)})}function ot(){var f=$("#chat-box-input"),i=f.val(),o,s;i.replace(/\s/g,"")!==""&&(o=e.encrypt(i,n.returnedKey||n.sentKey),s={sessionID:n.sessionID,recipientUsername:n.recipientUsername||n.sender,encryptedMsg:o},r.performPostRequest(t+"send-chat-message",s,function(){var t,r,u;f.val(""),t=document.createElement("p"),r=document.getElementById("chat-box-screen"),t.innerHTML='<span class="chat-box-nick chat-box-nick-first">'+n.name+':<\/span><span class="message-block">'+i+'<\/span><span class="message-time">'+y()+"<\/span>",r.appendChild(t),u=document.getElementById("chat-box-screen-wrapper"),p(u)},function(n){u(n)}))}function st(i){r.performGetRequest(t+"logout/"+n.sessionID,function(){clearInterval(nt),clearInterval(l),$("#main-nav").children("p").remove(),sessionStorage.clear(),tt()},function(n){u(n)}),i&&o(i)}function gt(){s=s-1,s<=0&&(alert("You were logged out because of 5 minutes non activity!"),st())}function f(n,t,i){n.addEventListener?n.addEventListener(t,i,!1):n.attachEvent&&n.attachEvent("on"+t,i)}function o(n){n.preventDefault?n.preventDefault():n.returnValue=!1}function y(){var t=new Date,i=t.getHours(),n=t.getMinutes(),r;return n<10&&(n="0"+n),r=i+":"+n,r+(i>11?"pm":"am")}function p(n){n.scrollTop=n.scrollHeight-n.clientHeight}var n=sessionStorage.getItem("name")?{isLoggedIn:!0,name:sessionStorage.getItem("name"),sessionID:sessionStorage.getItem("sessionID")}:{isLoggedIn:!1,name:"",sessionID:""};var t="http://cryptochat.apphb.com/CryptoChatService.svc/",w=document.getElementById("main-nav"),d=w.getElementsByTagName("ul")[0],ht=document.getElementById("left-sidebar"),h=document.getElementById("content"),b=document.getElementById("users-panel"),g=document.getElementById("info-panel"),c,s,nt,l,a={mainNavULHTML:'<li id="login-nav-button"><a href="#">Login<\/a><\/li><li id="register-nav-button"><a href="#">Register<\/a><\/li>',usersPanelHTML:"<p>In order to see the online users you need to login first!<\/p>",contentHTML:'<div id="before-login"><p>Get chatting with your friends...<\/p><p>They are waiting to have fun with you!<\/p><img src="img/friends.png" alt="Friends" width="534" height="334" /><\/div>',infoPanelHTML:"<p>In order to use current chat you need to know a secret word shared with a friend!<p>"},i={loadMainNavIfLogged:function(){var t=document.createElement("p"),i;t.innerHTML="Hello <span>"+n.name+"<\/span>",d.innerHTML='<li id="logout-nav-button"><a href="#">Logout<\/a><\/li>',w.insertBefore(t,w.firstChild),i=document.getElementById("logout-nav-button"),f(i,"click",st)},loadWhoInvitesYou:function(){var n=document.createElement("div");n.id="who-invites-you",n.innerHTML="<h3>Who invites you:<\/h3><ul><\/ul>",ht.appendChild(n)},loadChatBox:function(){var n;h.innerHTML='<div id="chat-box-wrapper"><div id="prepare-for-chat"><\/div><div id="chat-box-screen-wrapper"><div id="chat-box-screen"><\/div><\/div><textarea id="chat-box-input" placeholder="Send a message..." disabled><\/textarea><button id="cancel-chat" disabled>Cancel Chat<\/button><button id="chat-box-button" disabled>Send<\/button><\/div>',n=document.getElementById("chat-box-button"),f(n,"click",ot),$("#chat-box-input").keypress(function(n){n.which===13&&ot()})},loadInfoPanel:function(){g.innerHTML='<div id="server-messages"><h3>Server messages:<\/h3><ul><\/ul><\/div><div id="server-errors"><h3>Server errors:<\/h3><ul><\/ul><\/div>'}},r={performGetRequest:function(n,t,i){$.ajax({url:n,type:"GET",timeout:5e3,dataType:"json",success:t,error:i})},performPostRequest:function(n,t,i,r){$.support.cors=!0,$.ajax({url:n,type:"POST",contentType:"application/json",timeout:5e3,dataType:"json",data:JSON.stringify(t),success:i,error:r})}},e={encrypt:function(n,t){var i=CryptoJS.AES.encrypt(n.toString(),t);return i.toString()},decrypt:function(n,t){var i=CryptoJS.AES.decrypt(n,t);return i.toString(CryptoJS.enc.Utf8)},SHA1Algorithm:function(n,t){var i=CryptoJS.SHA1(n+t);return i.toString()}};return n.isLoggedIn?(i.loadMainNavIfLogged(),v(),i.loadWhoInvitesYou(),i.loadChatBox(),i.loadInfoPanel(),l=setInterval(et,500)):tt(),{serviceRootUrl:t}}();
//@ sourceMappingURL=script.min.js.map